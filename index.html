<html>
  <head>
    <meta charset="UTF-8" />
    <title>Minecraft Anvil Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      integrity="sha256-wLz3iY/cO4e6vKZ4zRmo4+9XDpMcgKOvv/zEU3OMlRo="
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha256-lSABj6XYH05NydBq+1dvkMu6uiCc/MbLYOFGRkf3iQs="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div class="modal show" id="uploadModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Minecraft Anvil Calculator v1.0</h5>
          </div>
          <div class="modal-body">
            <div id="editor" style="height: 21rem; width: 100%"></div>
          </div>
          <div class="modal-footer">
            <div
              id="formFileSpinner"
              class="spinner-border text-primary me-auto ms-auto"
              role="status"
              style="display: none"
            ></div>
            <button
              id="submit"
              type="submit"
              class="btn btn-primary ms-auto me-auto"
            >
              Submit
            </button>
          </div>
          <div class="modal-footer">
            <div id="editor2" style="height: 21rem; width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script type="module">
    import init, { process_wasm } from "./anvil_calc.js";
    var editor = ace.edit("editor");
    var editor2 = ace.edit("editor2");
    var spinner = document.getElementById("formFileSpinner");
    var start = document.getElementById("submit");
    editor.setOptions({
      mode: "ace/mode/yaml",
      tabSize: 2,
      wrap: true,
      showLineNumbers: false,
      showPrintMargin: false,
    });
    editor.getSession().on("changeAnnotation", function () {
      start.disabled = editor.getSession().getAnnotations().length > 0;
    });
    editor.setValue(
      `config:
  # Combining books is free when using Enchantment Library (Apotheosis)
  books_free: false
input:
  # [name, value (level*multiplier), work count]
  # https://minecraft.fandom.com/wiki/Anvil_mechanics#Costs_for_combining_enchantments
  items:
    - ["boots 1", 0, 0]
    - ["boots 2", 0, 0]
  books:
    - ["soul speed", 12, 0]
    - ["thorns", 12, 0]
    - ["feather falling", 4, 0]
    - ["depth strider", 6, 0]
    - ["protection", 4, 0]
    - ["unbreaking", 3, 0]
    # - ["mending", 2, 0]
`,
      1
    );
    editor2.setOptions({
      mode: "ace/mode/javascript",
      useWorker: false,
      wrap: true,
      showGutter: false,
      showPrintMargin: false,
    });
    editor2.setReadOnly(true);
    editor2.setValue("Click Submit to begin...\n", 1);
    init().then(() => {
      start.addEventListener("click", function () {
        spinner.style.display = "inline-block";
        start.style.display = "none";
        setTimeout(() => {
          editor2.setValue(process_wasm(editor.getValue()), 1);
          spinner.style.display = "none";
          start.style.display = "inline-block";
        }, 100);
      });
    });
    const modalElem = document.getElementById("uploadModal");
    const modal = new bootstrap.Modal(modalElem, {
      backdrop: "static",
      keyboard: false,
    });
    modal.show();
  </script>

  <script
    src="https://cdn.jsdelivr.net/npm/ace-builds@1.14.0/src-min-noconflict/ace.js"
    integrity="sha256-qRIzXhpaoqhHNJ5S32SoUuH2kvPkiZrXnKqUTZSjN9A="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/ace-builds@1.14.0/src-min-noconflict/worker-yaml.js"
    integrity="sha256-WEVJdz0KzxfL++nSNUvO7gPaX4nJvOhuUjX6NzXmoHI="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/ace-builds@1.14.0/src-min-noconflict/worker-javascript.js"
    integrity="sha256-5nU9x96IP0tXXKB9SbLvLRhmW7tcyhJ/mP8i33uXOGo="
    crossorigin="anonymous"
  ></script>
</html>
